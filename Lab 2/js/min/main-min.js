function initialize(){setMap()}function setMap(){function e(e,t,r){colorize=colorScale(t),jsonCountries=r.objects.europe.geometries;for(var a=0;a<t.length;a++){csvCountries=t[a];for(var o=parseFloat(csvCountries.id),n=csvCountries.adm0_a3,s=0;s<jsonCountries.length;s++)if(jsonCountries[s].properties.adm0_a3==n){for(var c in keyArray){var i=keyArray[c],u=parseFloat(csvCountries[i]);jsonCountries[s].properties[i]=u,jsonCountries[s].properties.id=o}jsonCountries[s].properties.admin=csvCountries.Country;break}}countries=map.append("path").datum(topojson.feature(r,r.objects.europe)).attr("class","countries").attr("d",path),countriesColor(t,r,countries),countriesCartogram=d3.selectAll("#mapType input[name=mode]").on("click",function(){var e,a;u=this.value;var o=0,n=0;"choropleth"===u?(cartogram=!1,map.selectAll("g").remove(),countries=map.append("path").datum(topojson.feature(r,r.objects.europe)).attr("class","countries").attr("d",path),countriesColor(t,r,countries)):"cartogram"===u&&(cartogram=!0,map.selectAll("g").remove(),countries=map.selectAll(".countriesEurope").data(topojson.feature(r,r.objects.europe).features).enter().append("g").attr("class","countriesEurope").append("path").attr("class",function(e){return e.properties.adm0_a3}).attr("d",path).attr("transform",function(r,n){var s=!1;if(e=jsonCountries[n].properties.adm0_a3,26>=o&&(currentCountry=t[o].adm0_a3,e==currentCountry)){a=path.centroid(r),x=a[0],y=a[1],"FRA"==e&&(x2=56.01966,y2=460.33119,s=!0),"NOR"==e&&(x2=385.609856,y2=130.790958,s=!0),"GRC"==e&&(x2=485.2475,y2=623.98259,s=!0),o++,n=0;var c=parseFloat(t[o-1].No_Languages);return 0==s?"translate("+x+","+y+")scale("+Math.sqrt(c/100||0)+")translate("+-x+","+-y+")":"translate("+x2+","+y2+")scale("+Math.sqrt(c/100||0)+")translate("+-x+","+-y+")"}}).style("fill",function(r,a){return 26>=n&&(currentCountry=t[n].adm0_a3),e=r.properties.adm0_a3,e!=currentCountry?"rgba(255,255,255,0)":void n++}),countriesColor(t,r,countries),changeAttribute("No_Languages",t,r))}),createDropdown(t,r),setChart(t,colorize)}var t=600,r=600;map=d3.select("body").append("svg").attr("width",t).attr("height",r).attr("class","map").style("stroke",function(e){return"#d4d4d8"});var a=d3.geo.conicConformal().center([-12,52.5]).rotate([-22,0]).parallels([43,62]).scale(940).translate([t/2,r/2]);path=d3.geo.path().projection(a);var o=d3.geo.graticule().step([10,10]),n=map.append("path").datum(o.outline).attr("class","gratBackground").attr("d",path),s=map.selectAll(".gratlines").data(o.lines).enter().append("path").attr("class","gratLines").attr("d",path);queue().defer(d3.csv,"data/data.csv").defer(d3.json,"data/europe.topojson").await(e)}function countriesColor(e,t,r){diffCountries=map.selectAll(".countriesEurope").data(topojson.feature(t,t.objects.europe).features).enter().append("g").attr("class","countriesEurope").append("path").attr("class",function(e){return e.properties.adm0_a3}).attr("d",path).style({stroke:"black"}).style("fill",function(e){return choropleth(e,colorize)}).on("mouseover",highlight).on("mouseout",dehighlight).on("mousemove",moveLabel).append("desc").text(function(e){return choropleth(e,colorize)})}function setChart(e,t){var r=d3.select("body").append("svg").attr("width",chartWidth).attr("height",chartHeight).attr("class","chart"),a=r.append("text").attr("x",20).attr("y",40).attr("class","chartTitle"),o=r.selectAll(".bar").data(e).enter().append("rect").sort(function(e,t){return e[expressed]-t[expressed]}).attr("class",function(e){return"bar "+e.adm0_a3}).attr("width",chartWidth/e.length-1).on("mouseover",highlight).on("mouseout",dehighlight).on("mousemove",moveLabel);updateChart(o,e.length)}function colorScale(e){var t=d3.scale.quantile().range(["#6baed6","#4292c6","#2171a5","#08519c","#08519c"]);return t.domain([d3.min(e,function(e){return Number(e[expressed])}),d3.max(e,function(e){return Number(e[expressed])})]),t}function choropleth(e,t){var r=e.properties?e.properties[expressed]:e[expressed];return r?t(r):"#f1f1f4"}function updateChart(e,t){e.attr("height",function(e,t){return 3*Number(e[expressed])}).attr("y",function(e,t){return chartHeight-3*Number(e[expressed])}).attr("x",function(e,r){return r*(chartWidth/t)}).style("fill",function(e){return choropleth(e,colorize)}),console.log(expressed),d3.select(".chartTitle").text("Percent_of_foreigner"!=expressed?"Percentages of people that know "+names(expressed).toLowerCase():"Percentages of foreigners")}function createDropdown(e,t){dropdown=d3.select("body").append("div").attr("class","dropdown").html("<h3>Select variable:</h3>").append("div").attr("class","selector").append("select").on("change",function(){attributeValue=this.value,changeAttribute(this.value,e,t)}),dropdown.selectAll("options").data(keyArray).enter().append("option").attr("value",function(e){return e}).text(function(e){var t=names(e);return t})}function changeAttribute(e,t,r){var a=0,o=0;expressed=e,colorize=colorScale(t),d3.selectAll(".countriesEurope").select("path").style("fill",function(e){return choropleth(e,colorize)}).select("desc").text(function(e){return choropleth(e,colorScale(t))}),1==cartogram&&(map.selectAll("g").remove(),countries=map.selectAll(".countriesEurope2").data(topojson.feature(r,r.objects.europe).features).enter().append("g").attr("class","countriesEurope").append("path").attr("class",function(e,t){return e.properties.adm0_a3}).attr("d",path).attr("transform",function(e,r){var o=!1;if(check=jsonCountries[r].properties.adm0_a3,26>=a&&(currentCountry=t[a].adm0_a3,check==currentCountry)){centroid=path.centroid(e),x=centroid[0],y=centroid[1],a++,r=0;var n;"No_Languages"==expressed&&(n=t[a-1].No_Languages,"FRA"==check&&(x2=55.01966,y2=395.33119,o=!0),"NOR"==check&&(x2=350.609856,y2=100.790958,o=!0),"GRC"==check&&(x2=425.2475,y2=525.98259,o=!0)),"One_Language"==expressed&&(n=t[a-1].One_Language,"FRA"==check&&(x2=67.01966,y2=390.33119,o=!0),"NOR"==check&&(x2=350.609856,y2=85.790958,o=!0),"GRC"==check&&(x2=430.2475,y2=530.98259,o=!0)),"Two_Languages"==expressed&&(n=t[a-1].Two_Languages,"FRA"==check&&(x2=104.01966,y2=385.33119,o=!0),"NOR"==check&&(x2=350.609856,y2=85.790958,o=!0),"GRC"==check&&(x2=415.2475,y2=520.98259,o=!0)),"Three_Languages_or_more"==expressed&&(n=t[a-1].Three_Languages_or_more,"FRA"==check&&(x2=155.01966,y2=375.33119,o=!0),"NOR"==check&&(x2=355.609856,y2=70.790958,o=!0),"GRC"==check&&(x2=420.2475,y2=520.98259,o=!0)),"Percent_of_foreigner"==expressed&&(n=t[a-1].Percent_of_foreigner,"FRA"==check&&(x2=150.01966,y2=378.33119,o=!0),"NOR"==check&&(x2=360.609856,y2=85.790958,o=!0),"GRC"==check&&(x2=419.2475,y2=525.98259,o=!0));var s=parseFloat(n);return 0==o?"translate("+x+","+y+")scale("+Math.sqrt(s/100||0)+")translate("+-x+","+-y+")":"translate("+x2+","+y2+")scale("+Math.sqrt(s/100||0)+")translate("+-x+","+-y+")"}}).style("fill",function(e){return choropleth(e,colorize)}).on("mouseover",highlight).on("mouseout",dehighlight).on("mousemove",moveLabel).append("desc").text(function(e){return choropleth(e,colorize)}).style("fill",function(e,r){return 26>=o&&(currentCountry=t[o].adm0_a3),check=e.properties.adm0_a3,check!=currentCountry?"rgba(255,255,255,0)":void o++}).style("fill",function(e){return choropleth(e,colorize)}).append("desc").text(function(e){return choropleth(e,colorScale(t))}));var n=d3.selectAll(".bar").sort(function(e,t){return e[expressed]-t[expressed]}).transition().delay(function(e,t){return 10*t});updateChart(n,t.length)}function highlight(e){var t=e.properties?e.properties:e;void 0!=t[expressed]&&d3.selectAll("."+t.adm0_a3).style("fill","#FDBAA0");var r=names(expressed)+": "+t[expressed],a;void 0==t.admin?a=t.Country:void 0!=t.admin&&(a=t.admin),void 0==t[expressed]||(infoLabel=d3.select("body").append("div").attr("class","infoLabel").attr("id",t.adm0_a3+"label").html(a+"</br>"+r+"%"))}function dehighlight(e){var t=e.properties?e.properties:e,r=d3.selectAll("."+t.adm0_a3),a=r.select("desc").text().substring(0,7);r.style("fill",a);var o=d3.select("#"+t.adm0_a3+"label").remove()}function moveLabel(){var e=d3.event.pageX+3,t=d3.event.pageY-45;d3.select(".infoLabel").style("left",e+"px").style("top",t+"px").transition().duration(300).style("opacity",.9)}function names(e){var t;return"No_Languages"==e?t="One language":"One_Language"==e?t="Two languages":"Two_Languages"==e?t="Three languages":"Three_Languages_or_more"==e?t="Four languages or more":"Percent_of_foreigner"==e&&(t="% of foreigner"),t}var keyArray=["No_Languages","One_Language","Two_Languages","Three_Languages_or_more","Percent_of_foreigner"],expressed=keyArray[0],chartWidth=550,chartHeight=499,colorize,map,value,path,diffCountries,countries,jsonCountries,csvCountries,currentCountry,dropdown,attributeValue,firstTime=!0,cartogram=!1,infoLabel;window.onload=initialize();