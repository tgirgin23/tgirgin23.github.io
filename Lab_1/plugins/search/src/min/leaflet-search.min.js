(function(){L.Control.Search=L.Control.extend({includes:L.Mixin.Events,options:{wrapper:"",url:"",jsonpParam:null,layer:null,callData:null,propertyName:"title",propertyLoc:"loc",callTip:null,filterJSON:null,minLength:1,initial:!0,autoType:!0,delayType:400,tooltipLimit:-1,tipAutoSubmit:!0,autoResize:!0,collapsed:!0,autoCollapse:!1,autoCollapseTime:1200,zoom:null,text:"Search...",textCancel:"Cancel",textErr:"Location not found",position:"topleft",animateLocation:!0,circleLocation:!0,markerLocation:!1,markerIcon:new L.Icon.Default},initialize:function(t){L.Util.setOptions(this,t||{}),this._inputMinSize=this.options.text?this.options.text.length:10,this._layer=this.options.layer||new L.LayerGroup,this._filterJSON=this.options.filterJSON||this._defaultFilterJSON,this._autoTypeTmp=this.options.autoType,this._countertips=0,this._recordsCache={}},onAdd:function(i){return this._map=i,this._container=L.DomUtil.create("div","leaflet-control-search"),this._input=this._createInput(this.options.text,"search-input"),this._tooltip=this._createTooltip("search-tooltip"),this._cancel=this._createCancel(this.options.textCancel,"search-cancel"),this._button=this._createButton(this.options.text,"search-button"),this._alert=this._createAlert("search-alert"),this.options.collapsed===!1&&this.expand(),(this.options.circleLocation||this.options.markerLocation||this.options.markerIcon)&&(this._markerLoc=new t([0,0],{showCircle:this.options.circleLocation,showMarker:this.options.markerLocation,icon:this.options.markerIcon})),this.setLayer(this._layer),i.on({resize:this._handleAutoresize},this),this._container},addTo:function(t){return this.options.wrapper?(this._container=this.onAdd(t),this._wrapper=L.DomUtil.get(this.options.wrapper),this._wrapper.style.position="relative",this._wrapper.appendChild(this._container)):L.Control.prototype.addTo.call(this,t),this},onRemove:function(){this._recordsCache={}},_getPath:function(t,i){var e=i.split("."),o=e.pop(),s=e.length,n=e[0],r=1;if(s>0)for(;(t=t[n])&&s>r;)n=e[r++];return t?t[o]:void 0},setLayer:function(t){return this._layer=t,this._layer.addTo(this._map),this._markerLoc&&this._layer.addLayer(this._markerLoc),this},showAlert:function(t){t=t||this.options.textErr,this._alert.style.display="block",this._alert.innerHTML=t,clearTimeout(this.timerAlert);var i=this;return this.timerAlert=setTimeout(function(){i.hideAlert()},this.options.autoCollapseTime),this},hideAlert:function(){return this._alert.style.display="none",this},cancel:function(){return this._input.value="",this._handleKeypress({keyCode:8}),this._input.size=this._inputMinSize,this._input.focus(),this._cancel.style.display="none",this},expand:function(){return this._input.style.display="block",L.DomUtil.addClass(this._container,"search-exp"),this._input.focus(),this._map.on("dragstart click",this.collapse,this),this},collapse:function(){return this._hideTooltip(),this.cancel(),this._alert.style.display="none",this._input.blur(),this.options.collapsed&&(this._input.style.display="none",this._cancel.style.display="none",L.DomUtil.removeClass(this._container,"search-exp"),this._map.off("dragstart click",this.collapse,this)),this.fire("search_collapsed"),this},collapseDelayed:function(){if(!this.options.autoCollapse)return this;var t=this;return clearTimeout(this.timerCollapse),this.timerCollapse=setTimeout(function(){t.collapse()},this.options.autoCollapseTime),this},collapseDelayedStop:function(){return clearTimeout(this.timerCollapse),this},_createAlert:function(t){var i=L.DomUtil.create("div",t,this._container);return i.style.display="none",L.DomEvent.on(i,"click",L.DomEvent.stop,this).on(i,"click",this.hideAlert,this),i},_createInput:function(t,i){var e=L.DomUtil.create("input",i,this._container);return e.type="text",e.size=this._inputMinSize,e.value="",e.autocomplete="off",e.autocorrect="off",e.autocapitalize="off",e.placeholder=t,e.style.display="none",L.DomEvent.disableClickPropagation(e).on(e,"keyup",this._handleKeypress,this).on(e,"keydown",this._handleAutoresize,this).on(e,"blur",this.collapseDelayed,this).on(e,"focus",this.collapseDelayedStop,this),e},_createCancel:function(t,i){var e=L.DomUtil.create("a",i,this._container);return e.href="#",e.title=t,e.style.display="none",e.innerHTML="<span>&otimes;</span>",L.DomEvent.on(e,"click",L.DomEvent.stop,this).on(e,"click",this.cancel,this),e},_createButton:function(t,i){var e=L.DomUtil.create("a",i,this._container);return e.href="#",e.title=t,L.DomEvent.on(e,"click",L.DomEvent.stop,this).on(e,"click",this._handleSubmit,this).on(e,"focus",this.collapseDelayedStop,this).on(e,"blur",this.collapseDelayed,this),e},_createTooltip:function(t){var i=L.DomUtil.create("div",t,this._container);i.style.display="none";var e=this;return L.DomEvent.disableClickPropagation(i).on(i,"blur",this.collapseDelayed,this).on(i,"mousewheel",function(t){e.collapseDelayedStop(),L.DomEvent.stopPropagation(t)},this).on(i,"mouseover",function(){e.collapseDelayedStop()},this),i},_createTip:function(t,i){var e;if(this.options.callTip){if(e=this.options.callTip(t,i),"string"==typeof e){var o=L.DomUtil.create("div");o.innerHTML=e,e=o.firstChild}}else e=L.DomUtil.create("a",""),e.href="#",e.innerHTML=t;return L.DomUtil.addClass(e,"search-tip"),e._text=t,L.DomEvent.disableClickPropagation(e).on(e,"click",L.DomEvent.stop,this).on(e,"click",function(){this._input.value=t,this._handleAutoresize(),this._input.focus(),this._hideTooltip(),this.options.tipAutoSubmit&&this._handleSubmit()},this),e},_filterRecords:function(t){var i,e,o=new RegExp("^[.]$|[[]|()*]","g"),s={};t=t.replace(o,""),i=this.options.initial?"^":"",e=new RegExp(i+t,"i");for(var n in this._recordsCache)e.test(n)&&(s[n]=this._recordsCache[n]);return s},showTooltip:function(){var t,i;this._countertips=0,t=this.options.layer?this._filterRecords(this._input.value):this._recordsCache,this._tooltip.innerHTML="",this._tooltip.currentSelection=-1;for(var e in t){if(++this._countertips==this.options.tooltipLimit)break;i=this._createTip(e,t[e]),this._tooltip.appendChild(i)}return this._countertips>0?(this._tooltip.style.display="block",this._autoTypeTmp&&this._autoType(),this._autoTypeTmp=this.options.autoType):this._hideTooltip(),this._tooltip.scrollTop=0,this._countertips},_hideTooltip:function(){return this._tooltip.style.display="none",this._tooltip.innerHTML="",0},_defaultFilterJSON:function(t){var i,e={},o=this.options.propertyName,s=this.options.propertyLoc;if(L.Util.isArray(s))for(i in t)e[this._getPath(t[i],o)]=L.latLng(t[i][s[0]],t[i][s[1]]);else for(i in t)e[this._getPath(t[i],o)]=L.latLng(this._getPath(t[i],s));return e},_recordsFromJsonp:function(t,i){var e=this;L.Control.Search.callJsonp=function(t){var o=e._filterJSON(t);i(o)};var o=L.DomUtil.create("script","search-jsonp",document.getElementsByTagName("body")[0]),s=L.Util.template(this.options.url+"&"+this.options.jsonpParam+"=L.Control.Search.callJsonp",{s:t});return o.type="text/javascript",o.src=s,this},_recordsFromAjax:function(t,i){void 0===window.XMLHttpRequest&&(window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP.6.0")}catch(t){try{return new ActiveXObject("Microsoft.XMLHTTP.3.0")}catch(i){throw new Error("XMLHttpRequest is not supported")}}});var e=new XMLHttpRequest,o=L.Util.template(this.options.url,{s:t}),s={};e.open("GET",o);var n=this;return e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){s=JSON.parse(e.responseText);var t=n._filterJSON(s);i(t)}},e.send(),this},_recordsFromLayer:function(){var i,e=this,o={},s=this.options.propertyName;return this._layer.eachLayer(function(n){n instanceof t||(n instanceof L.Marker?e._getPath(n.options,s)?(i=n.getLatLng(),i.layer=n,o[e._getPath(n.options,s)]=i):e._getPath(n.feature.properties,s)?(i=n.getLatLng(),i.layer=n,o[e._getPath(n.feature.properties,s)]=i):console.log("propertyName '"+s+"' not found in marker",n):n.hasOwnProperty("feature")&&(n.feature.properties.hasOwnProperty(s)?(i=n.getBounds().getCenter(),i.layer=n,o[n.feature.properties[s]]=i):console.log("propertyName '"+s+"' not found in feature",n)))},this),o},_autoType:function(){var t=this._input.value.length,i=this._tooltip.firstChild._text,e=i.length;if(0===i.indexOf(this._input.value))if(this._input.value=i,this._handleAutoresize(),this._input.createTextRange){var o=this._input.createTextRange();o.collapse(!0),o.moveStart("character",t),o.moveEnd("character",e),o.select()}else this._input.setSelectionRange?this._input.setSelectionRange(t,e):this._input.selectionStart&&(this._input.selectionStart=t,this._input.selectionEnd=e)},_hideAutoType:function(){var t;if((t=this._input.selection)&&t.empty)t.empty();else if(this._input.createTextRange){t=this._input.createTextRange(),t.collapse(!0);var i=this._input.value.length;t.moveStart("character",i),t.moveEnd("character",i),t.select()}else this._input.getSelection&&this._input.getSelection().removeAllRanges(),this._input.selectionStart=this._input.selectionEnd},_handleKeypress:function(t){switch(t.keyCode){case 27:this.collapse();break;case 13:1==this._countertips&&this._handleArrowSelect(1),this._handleSubmit();break;case 38:this._handleArrowSelect(-1);break;case 40:this._handleArrowSelect(1);break;case 37:case 39:case 16:case 17:break;case 8:case 46:this._autoTypeTmp=!1;break;default:if(this._cancel.style.display=this._input.value.length?"block":"none",this._input.value.length>=this.options.minLength){var i=this;clearTimeout(this.timerKeypress),this.timerKeypress=setTimeout(function(){i._fillRecordsCache()},this.options.delayType)}else this._hideTooltip()}},_fillRecordsCache:function(){var t,i=this._input.value;L.DomUtil.addClass(this._container,"search-load"),this.options.callData?(t=this,this.options.callData(i,function(i){t._recordsCache=t._filterJSON(i),t.showTooltip(),L.DomUtil.removeClass(t._container,"search-load")})):this.options.url?this.options.jsonpParam?(t=this,this._recordsFromJsonp(i,function(i){t._recordsCache=i,t.showTooltip(),L.DomUtil.removeClass(t._container,"search-load")})):(t=this,this._recordsFromAjax(i,function(i){t._recordsCache=i,t.showTooltip(),L.DomUtil.removeClass(t._container,"search-load")})):this.options.layer&&(this._recordsCache=this._recordsFromLayer(),this.showTooltip(),L.DomUtil.removeClass(this._container,"search-load"))},_handleAutoresize:function(){this._input.style.maxWidth!=this._map._container.offsetWidth&&(this._input.style.maxWidth=L.DomUtil.getStyle(this._map._container,"width")),this.options.autoResize&&this._container.offsetWidth+45<this._map._container.offsetWidth&&(this._input.size=this._input.value.length<this._inputMinSize?this._inputMinSize:this._input.value.length)},_handleArrowSelect:function(t){var e=this._tooltip.hasChildNodes()?this._tooltip.childNodes:[];for(i=0;i<e.length;i++)L.DomUtil.removeClass(e[i],"search-tip-select");if(1==t&&this._tooltip.currentSelection>=e.length-1)L.DomUtil.addClass(e[this._tooltip.currentSelection],"search-tip-select");else if(-1==t&&this._tooltip.currentSelection<=0)this._tooltip.currentSelection=-1;else if("none"!=this._tooltip.style.display){this._tooltip.currentSelection+=t,L.DomUtil.addClass(e[this._tooltip.currentSelection],"search-tip-select"),this._input.value=e[this._tooltip.currentSelection]._text;var o=e[this._tooltip.currentSelection].offsetTop;o+e[this._tooltip.currentSelection].clientHeight>=this._tooltip.scrollTop+this._tooltip.clientHeight?this._tooltip.scrollTop=o-this._tooltip.clientHeight+e[this._tooltip.currentSelection].clientHeight:o<=this._tooltip.scrollTop&&(this._tooltip.scrollTop=o)}},_handleSubmit:function(){if(this._hideAutoType(),this.hideAlert(),this._hideTooltip(),"none"==this._input.style.display)this.expand();else if(""===this._input.value)this.collapse();else{var t=this._getLocation(this._input.value);t===!1?this.showAlert():(this.showLocation(t,this._input.value),this.fire("search_locationfound",{latlng:t,text:this._input.value,layer:t.layer?t.layer:null}))}},_getLocation:function(t){return this._recordsCache.hasOwnProperty(t)?this._recordsCache[t]:!1},showLocation:function(t,i){return this.options.zoom?this._map.setView(t,this.options.zoom):this._map.panTo(t),this._markerLoc&&(this._markerLoc.setLatLng(t),this._markerLoc.setTitle(i),this._markerLoc.show(),this.options.animateLocation&&this._markerLoc.animate()),this.options.autoCollapse&&this.collapse(),this}});var t=L.Marker.extend({includes:L.Mixin.Events,options:{radius:10,weight:3,color:"#e03",stroke:!0,fill:!1,title:"",icon:new L.Icon.Default,showCircle:!0,showMarker:!1},initialize:function(t,i){L.setOptions(this,i),L.Marker.prototype.initialize.call(this,t,i),this.options.showCircle&&(this._circleLoc=new L.CircleMarker(t,this.options))},onAdd:function(t){L.Marker.prototype.onAdd.call(this,t),this._circleLoc&&t.addLayer(this._circleLoc),this.hide()},onRemove:function(t){L.Marker.prototype.onRemove.call(this,t),this._circleLoc&&t.removeLayer(this._circleLoc)},setLatLng:function(t){return L.Marker.prototype.setLatLng.call(this,t),this._circleLoc&&this._circleLoc.setLatLng(t),this},setTitle:function(t){return t=t||"",this.options.title=t,this._icon&&(this._icon.title=t),this},show:function(){return this.options.showMarker&&(this._icon&&(this._icon.style.display="block"),this._shadow&&(this._shadow.style.display="block")),this._circleLoc&&this._circleLoc.setStyle({fill:this.options.fill,stroke:this.options.stroke}),this},hide:function(){return this._icon&&(this._icon.style.display="none"),this._shadow&&(this._shadow.style.display="none"),this._circleLoc&&this._circleLoc.setStyle({fill:!1,stroke:!1}),this},animate:function(){if(this._circleLoc){var t=this._circleLoc,i=200,e=10,o=parseInt(t._radius/e),s=this.options.radius,n=2.5*t._radius,r=0;t._timerAnimLoc=setInterval(function(){r+=.5,o+=r,n-=o,t.setRadius(n),s>n&&(clearInterval(t._timerAnimLoc),t.setRadius(s))},i)}return this}});L.Map.addInitHook(function(){this.options.searchControl&&(this.searchControl=L.control.search(this.options.searchControl),this.addControl(this.searchControl))}),L.control.search=function(t){return new L.Control.Search(t)}}).call(this);